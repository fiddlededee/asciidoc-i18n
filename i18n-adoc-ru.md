—
author: Поташников Николай
date: 2022-01-11
subtitle: Подход с использованием `gettext`
title: Интернационализация (i18n) простой текстовой разметки
—
<cut/>

![xrjzpblczowgylzxmvefrjjt4og](https://habrastorage.org/webt/xr/jz/pb/xrjzpblczowgylzxmvefrjjt4og.jpeg)
<cut/>

# Введение 
<cut/>

[ Go to English version](https://habr.com/ru/post/599437/)
<cut/>

Несколько лет назад коллега опубликовал [статью](https://habr.com/ru/post/456032/) о создании презентации при помощи [Asciidoctor](https://asciidoctor.org/). С тех пор мы пользуемся только этим подходом.
<cut/>

Недавно возникла проблема перевести презентации на несколько языков и обеспечить синхронизацию переводов по мере доработки оригинала. Решение оказалось настолько простым и отработанным, что я решил описать его в этой статье.
<cut/>

Предлагаемое решение ничего не знает о синтаксисе. Это означает, что не так важно, используется Asciidoc, другой формат простой текстовой разметки или даже смешанный формат (например, включающий мои любимые Plantuml или любые другие диаграммы). Серьезные ограничения данного подхода  — (1) переводчик не должен ломать используемую разметку и (2) невозможно напрямую использовать машинный перевод.
<cut/>

Решение использует [Translation Toolkit](http://docs.translatehouse.org/projects/translate-toolkit/en/latest/) и стандартные [инструменты GNU Gettext](https://www.gnu.org/software/gettext/).
<cut/>

Для демонстрации подхода у данной статьи есть английская и русская версия. [В её репозитории](https://github.com/fiddlededee/asciidoc-i18n) настроена простая автоматизация, которая синхронизирует перевод, создает печатную версию статьи (pdf, docx, odt), а также создает файл в формате Markdown для публикации на Хабре.
<cut/>

В [предыдущей статье о тестировании документации](https://habr.com/ru/post/571326/) я только упомянул стандартные текстовые линтеры, т.к. старался сфокусироваться в целом на подходах к тестированию, а не конкретных инструментах. Тем не менее существующие линтеры могут очень и очень многое. Поэтому эта статья проверялась при помощи [vale](https://github.com/errata-ai/vale).
<cut/>

# Основная идея 
<cut/>

Gettext предполагает, что ключевые строки для перевода являются оригинальными сообщениями.
<cut/>

Gettext использует файлы расширением `.po` (PO — [Portable Object](https://www.gnu.org/software/gettext/manual/html_node/PO-Files.html#PO-Files)) для хранения как оригинальных, так и переведенных сообщений. Большое количество редакторов позволяет редактировать такие файлы как в однопользовательской, так и в многопользовательской среде.
<cut/>

Основная идея Translation Toolkit заключается в использовании блоков смежных строк в качестве констант для перевода.
<cut/>

Рассмотрим пример:
<cut/>

    .Зима -- это
<cut/>

    * снег
    * мороз
<cut/>

    * Рожество
    * Новый год
<cut/>

В примере показано три блока смежных строк, поэтому Translation Toolkit извлечёт три константы для перевода и поместит их в файл с расширением `.pot` (шаблон `.po`)
<cut/>

Вставляя или убирая переносы строк в данном примере вы можете получить любое количество констант в диапазоне от 1 до 5. Количество констант зависит от удобства для переводчика.
<cut/>

Используя файл `.pot` в качестве шаблона, Gettext создает (обновляет) файлы `.po` для всех требуемых языков. Переводчики работают именно с этими файлами. Далее Translation Toolkit берет (1) файл `.po` с переводом, (2) оригинальный файл и создает переведенный файл.
<cut/>

# Описание процесса 
<cut/>

Процесс перевода состоит из следующих шагов.
<cut/>

-   Исходные шаги для получения первого перевода на один или несколько языков.
<cut/>

-   Обновление перевода после модификации исходного текста.
<cut/>

На следующих диаграммах предполагается, что исходный файл —  `i18n-adoc.adoc`, а перевод должен быть помещен в файл `i18n-adoc-ru.adoc`.
<cut/>

## Исходные шаги 
<cut/>

![Исходные шаги](https://habrastorage.org/webt/kf/n4/wv/kfn4wvlwpq4js2ystmekr9avbec.png)
<cut/>

Существует много редакторов для перевода файлов `.po`. На следующем снимке экрана показан интерфейс [Gtranslator](https://wiki.gnome.org/Apps/Gtranslator). Я предпочитаю [Poedit](https://poedit.net/), хотя то, как он заменяет гравис на апостроф при использовании машинного перевода, раздражает.
<cut/>

![Перевод с использованием Gtranslator](https://habrastorage.org/webt/xe/yp/8q/xeyp8qzjmsdohjrmrccmoojupgo.png)
<cut/>

## Обновление перевода 
<cut/>

![Обновление перевода](https://habrastorage.org/webt/zj/q0/up/zjq0up9icxyk07k5bapm_6_pt4u.png)
<cut/>

# Несколько замечаний 
<cut/>

1.  В нашей документации мы часто повторно используем константы интернационализации, чтобы имена элементов интерфейса в документации совпадали с именами этих же элементов в приложении. Мы генерируем эти константы автоматически в следующем формате:
<cut/>

        :main-menu-documents: Документы
        :main-menu-documents-my: Мои
        ...
<cut/>

    Мы включаем этот файл в документ Asciidoc (`include i17n-{lang}.adoc[]`). Теперь нет необходимости использовать атрибуты. Просто переведите `include i17n-en.adoc[]` в `include i17n-ru.adoc[]`.
<cut/>

2.  Когда `gettext` обновляет файлы `.po`, он использует нечеткий поиск. Если вы немного измените исходный текст, перевод не пропадет. Он будет просто помечен как возможно неверный (flaky).
<cut/>

3.  Актуальность файла с переводом проверить очень легко при помощи утилиты Gettext  — `msgfmt`.
<cut/>

        msgfmt --statistics i18n-adoc-ru.po
<cut/>

    Команда показывает количество переведенных строк, количество строк, которые нуждаются в проверке, и количество непереведенных строк.
<cut/>

# Заключение 
<cut/>

-   Translation Toolkit и Gettext обеспечивают эффективную интернационализацию документации.
<cut/>

-   Простая текстовая разметка — не такая уж и простая. Использование всех возможностей простой текстовой разметки выставляет определенный уровень требований к специалисту по документации. Попробуйте представить переводчику файлы в формате `.po`. Многие ли из них будут готовы сделать перевод? Или попросят предоставить текст в более традиционном формате, например, в Microsoft Word.
<cut/>

-   Контроль качества: 58 переведенных сообщений, 0 ошибок, 0 предупреждений и 0 предложений в 1 файле.
