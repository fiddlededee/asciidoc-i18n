// tag::main[]
= Интернационализация простой текстовой разметки (i18n): Подход с использованием `gettext`
Поташников Николай
1.0, 18.11.2021
:lang: ru
:toc:
:toc-title: Содержание

[.portrait]
image::image1.png[width=100%]

== Введение

Несколько лет назад коллега опубликовал https://habr.com/ru/post/456032/[статью] о создании презентации при помощи https://asciidoctor.org/[Asciidoctor]. С тех пор мы пользуемся только этим подходом.

Недавно возникла проблема перевести презентации на несколько языков и обеспечить синхронизацию переводов по мере доработки оригинала. Решение оказалось настолько простым и отработанным, что я решил описать его в этой статье.

Предлагаемое решение ничего не знает о синтаксисе. Это означает, что не так важно, используется Asciidoc, другой формат простой текстовой разметки или даже смешанный формат (например, включающий мои любимые Plantuml или любые другие диаграммы). Серьезным ограничение данного подхода  -- (1) переводчик не должен ломать используемую разметку и (2) невозможно напрямую использовать машинный перевод (за исключением параграфов).

Решение использует http://docs.translatehouse.org/projects/translate-toolkit/en/latest/[Translation Toolkit] и стандартные https://www.gnu.org/software/gettext/[инструменты GNU Gettext].

Для демонсрации подхода у данной статьи есть английская и русская версия. В её репозитории настроена простая автоматизация, которая синхронизирует перевод, создает печатный версии статьи (pdf, docx, odt), а также создает файл в формате Markdown для публикации на Хабре.

В https://habr.com/ru/post/571326/[предыдущей статье о тестировании документации] только упомянул стандартные текстовые линтеры, т.к. старался сфокусироваться в целом на подходах к тестированию, а не конкретных инструментах. Тем не менее существующие линтеры могут очень и очень многое. Поэтому эта статья проверялась при помощи https://github.com/errata-ai/vale[vale].

== Основная идея

Gettext предполагает, что ключевые строки для перевода являются оригинальными сообщениями.

Gettext использует файлы PO для хранения как оригинальных, так и переведенных сообщений. Большое количество редакторов позволяет редактировать такие файлы как в однопользовательской, так и в многопользовательской среде.

Основная идея Translation Toolkit заключается в использовании блоков смежных строк в качестве констант для перевода.

Рассмотрим пример:
----
.Зима -- это

* снег
* мороз

* Рожество
* Новый год
----

В примере показано три блока смежных строк, поэтому Translation Toolkit извлечёт три константы для перевода.

Вставляя или убирая переносы строк вы можете получить любое количество констант в диапазоне от 1 до 5. Количество констант зависит от удобства для переводчика.

== Описание процесса

Процесс перевода состоит из следующих шагов.

* Исходные шаги для получения первого перевода на один или несколько языков.
* Обновление перевода после модификации исходного текста.

На следующих диаграммах предполагается, что исходный файл --  `i18n-adoc.adoc`, а перевод должен быть помещен в файл `i18n-adoc-ru.adoc`.

.Initial steps
[plantuml,initial_steps.png,fitrect="170x250mm",srcdpi=300]
....
@startuml
skinparam dpi 300

:Создайте шаблон PO-файла
====
<code>
txt2po -P i18n-adoc.adoc i18n-adoc.pot
</code>;

:Инициализируйте PO-файл для нужного языка 
====
<code>
msginit --no-translator -l ru_RU -o i18n-adoc-ru.po
</code>;

:Сделайте перевод
====
Gtranslator, Poedit etc.;

:Создайте (обновите) перевод
====
<code>
po2txt -t i18n-adoc.adoc i18n-adoc-ru.po i18n-adoc-ru.adoc
</code>;

@enduml
....


.Translating in Gtranslator
image::1.png[width=100%]

.Обновление перевода
[plantuml,updating-translation.png,fitrect="170x250mm",srcdpi=300]
....
@startuml
skinparam dpi 300

:Создайте шаблон PO-файла
====
<code>
txt2po -P i18n-adoc.adoc i18n-adoc.pot
</code>;

:Объедените шаблон с существующим PO-файлом
====
<code>
txt2po -P i18n-adoc.adoc i18n-adoc.pot
</code>;

:Обновите перевод
====
Gtranslator, Poedit etc.;

:Создайте (обновите) перевод
====
<code>
po2txt -t i18n-adoc.adoc i18n-adoc-ru.po i18n-adoc-ru.adoc
</code>;

@enduml
....
// end::main[]

== Несколько замечаний

. В нашей документации мы часто повторно используем константы интернационализации, чтобы имена элементов интерфейса в документации совпадали с именами этих же элементов в приложении. Мы генерируем эти константы автоматически в следующем формате:
+

----
:main-menu-documents: Документы
:main-menu-documents-my: Мои
...
----
+

Мы включаем этот файл в документ Asciidoc (`include i17n-\{lang}.adoc[]`). Теперь нет необходимости использовать атрибуты. Просто переведите `include i17n-en.adoc[]` в `include i17n-ru.adoc[]`.

. Когда `gettext` обновляет файлы PO, он использует нечеткий поиск. Если вы немного измените исходный текст,  перевод не пропадет. Он будет просто помечен как возможно неверный (flaky).

. Актуальность файла c переводом проверить очень легко
+

----
msgfmt --statistics i18n-adoc-ru.po
----
+

Команда показывает количество переведенных строк, количество строк, которые нуждаются в проверке, и количество непереведенных строк.

== Заключение

* Я начал использовать простую текстовую разметку, когда понял, что мне надо создавать много хорошо оформленной документации. Потом оказалось, что документацию в формате простой текстовой разметки легко автоматически генерировать и поддерживать в актуальном состоянии. Далее выяснилось, что обеспечивать качество содержания документации в простой текстовой разметке также достаточно просто. И сейчас выяснилось, что проблемы интернационализации документов также решаются технологично.

* Простая текстовая разметка -- не такая уж и простая. Использование всех возможностей простой текстовой разметки выставляет определенный уровень требований к специалисту по документации. Попробуйте представить переводчику файлы в формате PO. Многие ли из них будут готовы сделать перевод? Или попросят предоставить текст в НОРМАЛЬНОМ формате, например, в Microsoft Word?

* Контроль качества: 47 переведенных сообщений, 0 ошибок, 0 предупреждений и 0 предложений в 1 файле.